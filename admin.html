<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SECURE TERMINAL | 篠ノ井技術クラブ</title>
    <link rel="stylesheet" href="/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Noto+Sans+JP:wght@400;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { background: #000; color: #fff; margin: 0; font-family: 'Noto Sans JP', sans-serif; overflow-x: hidden; }
        
        /* ログイン前画面 */
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 1000; display: flex; align-items: center; justify-content: center;
        }
        .login-panel {
            border: 1px solid #00aeef; padding: 40px; border-radius: 2px;
            background: rgba(0, 174, 239, 0.05); text-align: center; width: 300px;
        }

        /* ログイン後メイン */
        .admin-main { display: none; max-width: 900px; margin: 0 auto; padding: 20px; }
        
        header { border-bottom: 1px solid #333; padding: 20px 0; margin-bottom: 30px; display: flex; justify-content: space-between; }
        .terminal-title { font-family: 'Orbitron'; color: #00aeef; letter-spacing: 2px; margin: 0; }

        .key-input-area {
            background: #111; border: 1px solid #ff00ff; padding: 20px;
            margin-bottom: 30px; display: flex; gap: 10px; align-items: center;
        }
        
        input {
            background: #000; border: 1px solid #333; color: #fff;
            padding: 10px; border-radius: 4px; font-family: 'Orbitron';
        }
        input:focus { border-color: #00aeef; outline: none; }

        .inquiry-card {
            background: #0a0a0a; border: 1px solid #222; padding: 20px;
            margin-bottom: 15px; border-left: 4px solid #333; transition: 0.3s;
        }
        .inquiry-card.decrypted { border-left-color: #00aeef; background: #000a10; }
        
        .msg-body {
            background: #000; padding: 15px; margin-top: 10px;
            color: #444; font-size: 0.9rem; word-break: break-all; border: 1px dashed #222;
        }
        .decrypted-text { color: #00aeef !important; }

        .btn {
            cursor: pointer; border: none; padding: 10px 20px;
            font-family: 'Orbitron'; font-weight: 900; transition: 0.3s;
        }
        .btn-blue { background: #00aeef; color: #000; }
        .btn-pink { background: #ff00ff; color: #fff; }
        .btn:hover { opacity: 0.7; transform: scale(0.98); }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="login-panel">
            <h2 style="font-family: 'Orbitron'; font-size: 1rem; color: #00aeef;">ADMIN ACCESS</h2>
            <input type="email" id="email" placeholder="ADMIN EMAIL" style="width: 100%;">
            <input type="password" id="pass" placeholder="PASSWORD" style="width: 100%;">
            <button class="btn btn-blue" onclick="handleLogin()" style="width: 100%; margin-top: 20px;">AUTHORIZE</button>
        </div>
    </div>

    <div id="admin-content" class="admin-main">
        <header>
            <h1 class="terminal-title">SYSTEM MANAGEMENT</h1>
            <button onclick="handleLogout()" style="background:none; border:1px solid #333; color:#555; cursor:pointer; font-size:0.7rem;">LOGOUT</button>
        </header>

        <div class="key-input-area">
            <div style="flex-grow: 1;">
                <p style="margin:0 0 5px 0; font-size:0.7rem; color:#ff00ff; font-family:'Orbitron';">ENCRYPTION KEY REQUIRED</p>
                <input type="password" id="decode-key" placeholder="INPUT KEY TO VIEW DATA" style="width: 90%;">
            </div>
            <button class="btn btn-pink" onclick="executeDecrypt()">DECRYPT</button>
        </div>

        <div id="list-container"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBwT-Df-5F4Wdyg-nJfg1OPolTMNUN0srg",
            authDomain: "shinonoi-gizyutu.firebaseapp.com",
            projectId: "shinonoi-gizyutu",
            storageBucket: "shinonoi-gizyutu.firebasestorage.app",
            messagingSenderId: "650750036178",
            appId: "1:650750036178:web:f50da8d54383510b6dc50b"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ログイン処理
        async function handleLogin() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('pass').value;
            try { await auth.signInWithEmailAndPassword(e, p); } catch(err) { alert('LOGIN FAILED'); }
        }

        function handleLogout() { auth.signOut(); location.reload(); }

        // 認証監視
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                startListening();
            } else {
                document.getElementById('auth-overlay').style.display = 'flex';
                document.getElementById('admin-content').style.display = 'none';
            }
        });

        // リアルタイム取得
        function startListening() {
            db.collection("inquiries").orderBy("timestamp", "desc").onSnapshot(snap => {
                const container = document.getElementById('list-container');
                container.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const card = document.createElement('div');
                    card.className = 'inquiry-card';
                    card.innerHTML = `
                        <div style="font-size:0.7rem; color:#666; font-family:'Orbitron';">${d.timestamp?.toDate().toLocaleString()}</div>
                        <div style="font-weight:900; margin:5px 0;">${d.name} (${d.category})</div>
                        <div class="msg-body">${d.message}</div>
                        <div style="margin-top:10px;">
                            <button onclick="deleteInquiry('${doc.id}')" style="background:none; border:none; color:#f44; cursor:pointer; font-size:0.7rem;">[ DELETE ]</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            });
        }

        // 復号化実行（ソースに合言葉は書かない）
        function executeDecrypt() {
            const key = document.getElementById('decode-key').value;
            if(!key) return;
            
            const boxes = document.querySelectorAll('.msg-body');
            boxes.forEach(box => {
                try {
                    const decrypted = CryptoJS.AES.decrypt(box.innerText, key).toString(CryptoJS.enc.Utf8);
                    if(decrypted) {
                        box.innerText = decrypted;
                        box.classList.add('decrypted-text');
                        box.parentElement.classList.add('decrypted');
                    }
                } catch(e) { /* 合言葉間違い時は何もしない */ }
            });
        }

        async function deleteInquiry(id) {
            if(confirm('REMOVE DATA?')) await db.collection("inquiries").doc(id).delete();
        }
    </script>
</body>
</html>
