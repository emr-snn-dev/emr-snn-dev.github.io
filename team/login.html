<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEMBER LOGIN | 篠ノ井技術クラブ</title>
    <link rel="stylesheet" href="/style.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@900&display=swap" rel="stylesheet">
    <style>
        body { background: #0b1d2e; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: sans-serif; overflow: hidden; }
        .login-card { background: rgba(16, 42, 67, 0.9); padding: 40px; border-radius: 24px; border: 1px solid #00aeef; box-shadow: 0 0 40px rgba(0, 174, 239, 0.2); text-align: center; width: 90%; max-width: 380px; backdrop-filter: blur(10px); }
        .club-logo { width: 90px; height: 90px; margin-bottom: 15px; filter: drop-shadow(0 0 15px #00aeef); }
        .club-title { font-family: 'Orbitron'; color: #00aeef; font-size: 1.1rem; margin-bottom: 30px; letter-spacing: 3px; }
        
        /* パスワード入力エリア */
        .input-group { margin-bottom: 20px; }
        input[type="password"] { width: 100%; padding: 14px; background: #0b1d2e; border: 1px solid #486581; border-radius: 12px; color: white; text-align: center; box-sizing: border-box; outline: none; font-size: 1rem; transition: 0.3s; }
        input[type="password"]:focus { border-color: #00aeef; box-shadow: 0 0 10px rgba(0, 174, 239, 0.3); }
        
        /* ボタン類 */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: 900; cursor: pointer; transition: 0.3s; font-size: 0.9rem; margin-bottom: 15px; }
        .btn-primary { background: #00aeef; color: white; }
        .btn-primary:hover { background: #0082b3; transform: translateY(-2px); }
        .btn-primary:disabled { background: #486581; cursor: not-allowed; transform: none; }
        
        .divider { display: flex; align-items: center; margin: 20px 0; color: #486581; font-size: 0.7rem; }
        .divider::before, .divider::after { content: ""; flex: 1; height: 1px; background: #1a3a5a; margin: 0 10px; }
        
        .btn-google { background: white; color: #757575; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-google img { width: 18px; }
        .btn-google:hover { background: #f1f1f1; }

        #lock-msg { color: #ff4d4d; font-size: 0.75rem; margin-top: 10px; display: none; background: rgba(255, 77, 77, 0.1); padding: 8px; border-radius: 8px; }
    </style>
</head>
<body>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('code') !== 'SNN_2026') { window.location.href = "/index.html"; }
    </script>

    <div class="login-card">
        <img src="/images/logo.png" alt="LOGO" class="club-logo">
        <div class="club-title">MEMBER ACCESS</div>
        
        <div class="input-group">
            <input type="password" id="club-pass" placeholder="合言葉（パスワード）">
        </div>
        <button id="login-btn" class="btn btn-primary" onclick="checkClubPassword()">MEMBER LOGIN</button>
        <div id="lock-msg">5回失敗したためロックされています。5分後にやり直してください。</div>

        <div class="divider">OR USE GOOGLE</div>

        <button class="btn btn-google" onclick="loginWithGoogle()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G">
            Sign in with Google
        </button>

        <p style="color: #486581; font-size: 0.7rem; margin-top: 20px;">
            篠ノ井技術クラブ専用ポータル<br>不正アクセスは記録されています
        </p>
    </div>

    <script src="/menu.js"></script>
    <script>
        const MAX_ATTEMPTS = 5;
        const LOCK_TIME = 5 * 60 * 1000;

        function checkLock() {
            const lockUntil = localStorage.getItem('login_lock_until');
            if (lockUntil && Date.now() < lockUntil) {
                document.getElementById('login-btn').disabled = true;
                document.getElementById('lock-msg').style.display = 'block';
                return true;
            }
            document.getElementById('login-btn').disabled = false;
            document.getElementById('lock-msg').style.display = 'none';
            return false;
        }

        setInterval(checkLock, 1000);

        // 合言葉ログイン
        async function checkClubPassword() {
            if (checkLock()) return;
            const inputPass = document.getElementById('club-pass').value;
            const guestEmail = "guest@snn.example.com"; 
            const guestPass = "shinonoi2026"; 

            if (inputPass === guestPass) {
                try {
                    await firebase.auth().signInWithEmailAndPassword(guestEmail, guestPass);
                    localStorage.removeItem('login_attempts');
                    window.location.href = "/activity-log.html";
                } catch (e) { alert("認証エラーが発生しました"); }
            } else {
                let attempts = parseInt(localStorage.getItem('login_attempts') || 0) + 1;
                localStorage.setItem('login_attempts', attempts);
                if (attempts >= MAX_ATTEMPTS) {
                    localStorage.setItem('login_lock_until', Date.now() + LOCK_TIME);
                } else {
                    alert("パスワードが違います。残り: " + (MAX_ATTEMPTS - attempts) + "回");
                }
            }
        }

        // Googleログイン
        function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            firebase.auth().signInWithPopup(provider)
            .then(() => { window.location.href = "/activity-log.html"; })
            .catch((e) => { alert("Googleログインに失敗しました"); });
        }
    </script>
</body>
</html>
