<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BLOG | 篠ノ井技術クラブ</title>
    <link rel="stylesheet" href="/style.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Noto+Sans+JP:wght@400;900&display=swap" rel="stylesheet">
    <style id="security-styles">
        body { 
            background: #0b1d2e; 
            color: white; 
            margin: 0; 
            font-family: 'Noto Sans JP', sans-serif;
            -webkit-user-select: none; 
            user-select: none; 
            -webkit-touch-callout: none;
        }
        .img-guard {
            position: relative;
            display: inline-block;
        }
        .img-guard::after {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0);
            z-index: 10;
        }
        img {
            pointer-events: none;
        }
    </style>
    <style>
        /* レイアウト */
        .main-layout { display: grid; grid-template-columns: 1fr 300px; gap: 30px; max-width: 1200px; margin: 0 auto; padding: 140px 20px 60px; }
        .content-area { min-width: 0; }
        .sidebar { position: sticky; top: 120px; height: fit-content; z-index: 50; }
        .side-widget { background: rgba(16, 42, 67, 0.6); border: 1px solid #1e3a5f; border-radius: 15px; padding: 20px; margin-bottom: 25px; backdrop-filter: blur(10px); }
        .widget-title { font-family: 'Orbitron'; font-size: 0.8rem; color: #00aeef; border-bottom: 1px solid #1e3a5f; padding-bottom: 10px; margin-bottom: 15px; letter-spacing: 2px; font-weight: 900; }
        
        /* 警告ウィジェット用スタイル */
        .warning-box { border: 1px solid #ff4d4d; background: rgba(255, 77, 77, 0.1); padding: 15px; border-radius: 10px; }
        .warning-text { font-size: 0.75rem; color: #ffb3b3; line-height: 1.5; margin: 0; }
        .security-link { display: block; margin-top: 10px; color: #00aeef; font-family: 'Orbitron'; font-size: 0.7rem; font-weight: 900; text-decoration: none; transition: 0.3s; }
        .security-link:hover { text-shadow: 0 0 10px #00aeef; }

        /* カテゴリーボタン */
        .cat-list { list-style: none; padding: 0; margin: 0; display: flex; flex-wrap: wrap; gap: 8px; }
        .cat-item { padding: 6px 12px; border: 1px solid #1e3a5f; cursor: pointer; color: #94a3b8; font-size: 0.75rem; border-radius: 5px; transition: 0.2s; background: rgba(0,0,0,0.2); }
        .cat-item.active { background: #00aeef; color: white; border-color: #00aeef; font-weight: 900; box-shadow: 0 0 10px rgba(0, 174, 239, 0.4); }

        /* ブログカード */
        .blog-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .blog-card { background: rgba(16, 42, 67, 0.4); border-radius: 12px; border: 1px solid #1e3a5f; padding: 25px; cursor: pointer; transition: 0.3s; position: relative; }
        .blog-card:hover { border-color: #00aeef; transform: translateY(-3px); background: rgba(16, 42, 67, 0.6); }
        .category-label { display: inline-block; background: #00aeef; color: white; font-family: 'Orbitron'; font-size: 0.6rem; font-weight: 900; padding: 2px 10px; border-radius: 4px; margin-left: 10px; }

        /* 写真サイズ・スライダー調整 */
        .photo-slider { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 15px; padding: 10px 0; scrollbar-width: none; }
        .photo-slider img { flex: 0 0 auto; scroll-snap-align: center; max-width: 100%; max-height: 400px; width: auto; height: auto; border-radius: 12px; border: 1px solid #1e3a5f; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .markdown-body img:not(.photo-slider img) { max-width: 100%; max-height: 400px; height: auto; border-radius: 8px; display: block; margin: 20px auto; }

        /* ナビゲーションボタン */
        .post-nav-container { display: flex; justify-content: space-between; gap: 20px; margin-top: 50px; border-top: 1px solid #1e3a5f; padding-top: 30px; }
        .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 18px; border: 1px solid #1e3a5f; border-radius: 12px; background: rgba(30, 58, 95, 0.2); color: #00aeef; cursor: pointer; transition: 0.3s; max-width: 48%; }
        .nav-btn:hover { background: rgba(0, 174, 239, 0.1); border-color: #00aeef; box-shadow: 0 0 20px rgba(0, 174, 239, 0.3); }
        .nav-btn .nav-label { font-family: 'Orbitron'; font-size: 0.65rem; font-weight: 900; color: #94a3b8; margin-bottom: 8px; letter-spacing: 1px; }
        .nav-btn .nav-arrow { font-size: 1.4rem; font-weight: 900; }
        .nav-btn.disabled { visibility: hidden; pointer-events: none; }

        /* ビューワー */
        #blog-viewer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5, 15, 25, 0.99); z-index: 100000; overflow-y: auto; backdrop-filter: blur(20px); }
        .viewer-inner { max-width: 800px; margin: 60px auto; background: #0b1d2e; padding: 50px; border-radius: 24px; border: 1px solid #1e3a5f; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .close-btn { position: sticky; top: 20px; float: right; background: #ff4d4d; color: white; border: none; padding: 12px 24px; border-radius: 50px; cursor: pointer; z-index: 100001; font-family: 'Orbitron'; font-weight: 900; box-shadow: 0 4px 15px rgba(255, 77, 77, 0.3); }

        @media (max-width: 900px) {
            .main-layout { grid-template-columns: 1fr; padding-top: 100px; }
            .sidebar { order: -1; position: relative; top: 0; }
            .viewer-inner { margin: 15px; padding: 25px; border-radius: 15px; }
            .photo-slider img { max-height: 300px; }
        }
    </style>
</head>
<body oncontextmenu="return false;" onselectstart="return false;" ondragstart="return false;">

    <div id="nav-container"></div>

    <main class="main-layout">
        <section class="content-area">
            <div id="blog-list" class="blog-grid">データを同期中...</div>
        </section>
        
        <aside class="sidebar">
            <div class="side-widget">
                <h2 class="widget-title">SCHEDULE</h2>
                <div id="event-display">読み込み中...</div>
            </div>

            <div class="side-widget">
                <h2 class="widget-title">CATEGORIES</h2>
                <ul class="cat-list" id="category-list"></ul>
            </div>

            <div class="side-widget">
                <h2 class="widget-title">SECURITY</h2>
                <div class="warning-box">
                    <p class="warning-text">
                        ⚠️ <strong>警告</strong><br>
                        当サイト内の画像・文章の無断転載および二次利用は固く禁じています。すべての操作は監視・制限されています。
                    </p>
                    <a href="/copyright.html" class="security-link">VIEW POLICY ></a>
                </div>
            </div>

            <div class="side-widget ad-widget">
                <h2 class="widget-title">SPONSOR</h2>
                <div class="ad-content">
                    <img src="https://via.placeholder.com/300x150/1e3a5f/00aeef?text=SHINOI+ECO-CAR" alt="AD" style="width:100%; border-radius:8px;">
                </div>
            </div>
        </aside>
    </main>

    <div id="blog-viewer">
        <div class="viewer-inner">
            <button class="close-btn" onclick="closePost()">CLOSE</button>
            <div id="post-content" class="markdown-body"></div>
            <div class="post-nav-container" id="post-navigation"></div>
            <div style="text-align:center; margin-top:50px;">
                <button id="copy-btn" style="background:none; border:1px solid #1e3a5f; color:#5c7080; padding:12px 30px; border-radius:50px; cursor:pointer; font-family:'Orbitron'; font-size:0.65rem; letter-spacing:2px;" onclick="copyURL()">SHARE POST URL</button>
            </div>
        </div>
    </div>

    <div id="copy-toast" style="position:fixed; bottom:50px; left:50%; transform:translateX(-50%); background:#00aeef; color:white; padding:12px 25px; border-radius:50px; display:none; z-index:200000; font-family:'Orbitron'; font-weight:900; box-shadow:0 0 20px rgba(0,174,239,0.5);">COPIED</div>

    <script src="/menu.js"></script>

    <script>
        // 不正操作への警告
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && (e.key === 's' || e.key === 'u' || e.key === 'i' || e.key === 'j')) {
                e.preventDefault();
                alert("セキュリティ上の理由により、この操作は無効化されています。");
            }
        });

        const REPO = "emr-snn-dev/emr-snn-dev.github.io";
        const CAL_ID = "373a1a4fda869bb27bafd57df85f2736ac20bb224e6733897f74bc1e221647a@group.calendar.google.com";
        const API_K = "AQ.Ab8RN6LfDBSjoikeSI1C0D09OaytknKr9IfWrwNvx0dpoz45OA";

        let postsData = [];

        async function fetchCalendar() {
            try {
                const now = new Date().toISOString();
                const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CAL_ID)}/events?key=${API_K}&timeMin=${now}&maxResults=3&singleEvents=true&orderBy=startTime`;
                const res = await fetch(url);
                const data = await res.json();
                const container = document.getElementById('event-display');
                if (data.items && data.items.length > 0) {
                    container.innerHTML = data.items.map(item => {
                        const start = new Date(item.start.dateTime || item.start.date);
                        return `<div class="event-item"><div><span class="event-day">${start.getDate()}</span><span class="event-month">${start.toLocaleString('en-us',{month:'SHORT'}).toUpperCase()}</span></div><div><span class="event-title">${item.summary}</span></div></div>`;
                    }).join('');
                } else { container.innerHTML = '<p style="font-size:0.7rem; color:#94a3b8;">NO SCHEDULE</p>'; }
            } catch (e) { document.getElementById('event-display').innerHTML = 'LOAD ERROR'; }
        }

        firebase.auth().onAuthStateChanged((user) => {
            initBlog();
            fetchCalendar();
        });

        async function initBlog() {
            try {
                const res = await fetch(`https://api.github.com/repos/${REPO}/contents/blog?t=${Date.now()}`);
                const files = await res.json();
                const mdFiles = files.filter(f => f.name.endsWith('.md')).reverse();
                const cats = new Set();
                postsData = mdFiles.map((f, i) => {
                    const name = f.name.replace('.md', '');
                    const c = name.match(/\[(.*?)\]/)?.[1] || 'ETC';
                    cats.add(c);
                    return { url: f.download_url, fileName: f.name, date: name.match(/^(\d{8})/)?.[1] || '', category: c, title: name.replace(/^\d+_/, '').replace(/\[.*?\]/, '').replace(/_/g, ' ').trim(), id: i };
                });
                document.getElementById('category-list').innerHTML = `<li class="cat-item active" id="cat-ALL" onclick="filterCategory('ALL', this)">ALL</li>` + 
                    Array.from(cats).map(c => `<li class="cat-item" id="cat-${c}" onclick="filterCategory('${c}', this)">${c}</li>`).join('');
                renderList(postsData);
                const p = new URLSearchParams(window.location.search);
                if (p.get('post')) { const idx = postsData.findIndex(i => i.fileName === p.get('post')); if(idx !== -1) openPost(idx); }
            } catch (e) { document.getElementById('blog-list').innerText = "取得失敗"; }
        }

        function renderList(data) {
            document.getElementById('blog-list').innerHTML = data.map(p => `
                <article class="blog-card" data-cat="${p.category}" onclick="openPost(${p.id})">
                    <span style="color:#00aeef; font-size:0.7rem; font-family:'Orbitron'; font-weight:900;">${p.date}</span>
                    <span class="category-label">${p.category}</span>
                    <h3 style="margin:10px 0 0; font-size:1.1rem; line-height:1.4;">${p.title}</h3>
                </article>
            `).join('');
        }

        async function openPost(index) {
            const post = postsData[index];
            if (!post) return;
            window.history.replaceState(null, null, `?post=${post.fileName}`);
            document.getElementById('blog-viewer').style.display = 'block';
            document.body.style.overflow = 'hidden';
            const res = await fetch(`${post.url}?t=${Date.now()}`);
            let html = marked.parse(await res.text());
            const temp = document.createElement('div'); temp.innerHTML = html;
            
            const imgs = temp.querySelectorAll('img');
            imgs.forEach(img => {
                const wrapper = document.createElement('div');
                wrapper.className = 'img-guard';
                img.parentNode.insertBefore(wrapper, img);
                wrapper.appendChild(img);
            });

            if (imgs.length >= 2) {
                const s = document.createElement('div'); s.className = 'photo-slider';
                imgs.forEach(img => s.appendChild(img.parentNode));
                const firstChild = temp.firstChild;
                temp.insertBefore(s, firstChild);
                html = temp.innerHTML;
            }
            document.getElementById('post-content').innerHTML = html;
            
            document.getElementById('post-navigation').innerHTML = `
                <div class="nav-btn ${!postsData[index+1] ? 'disabled' : ''}" onclick="openPost(${index + 1})">
                    <span class="nav-label">PREV POST</span>
                    <span class="nav-arrow">←</span>
                </div>
                <div class="nav-btn ${!postsData[index-1] ? 'disabled' : ''}" onclick="openPost(${index - 1})">
                    <span class="nav-label">NEXT POST</span>
                    <span class="nav-arrow">→</span>
                </div>
            `;
            document.getElementById('blog-viewer').scrollTo(0,0);
        }

        function closePost() { window.history.replaceState(null, null, window.location.pathname); document.getElementById('blog-viewer').style.display = 'none'; document.body.style.overflow = 'auto'; }
        
        function filterCategory(cat, el) {
            document.querySelectorAll('.cat-item').forEach(i => i.classList.remove('active')); el.classList.add('active');
            document.querySelectorAll('.blog-card').forEach(c => { c.style.display = (cat === 'ALL' || c.dataset.cat === cat) ? 'block' : 'none'; });
        }

        async function copyURL() {
            await navigator.clipboard.writeText(window.location.href);
            const t = document.getElementById('copy-toast'); t.style.display = 'block';
            setTimeout(() => { t.style.display = 'none'; }, 2000);
        }
    </script>
</body>
</html>
