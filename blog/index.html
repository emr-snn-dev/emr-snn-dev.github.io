<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BLOG | 篠ノ井技術クラブ</title>
    <link rel="stylesheet" href="/style.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Noto+Sans+JP:wght@400;900&display=swap" rel="stylesheet">
    <style>
        /* 基礎設定 & セキュリティ */
        body { 
            background: #0b1d2e; color: white; margin: 0; 
            font-family: 'Noto Sans JP', sans-serif;
            -webkit-user-select: none; user-select: none;
            overflow-x: hidden;
        }

        /* 印刷・スクショ対策 */
        @media print { body { display: none !important; } }

        /* レイアウト */
        .main-layout { max-width: 1200px; margin: 0 auto; padding: 100px 15px 120px; }

        /* カテゴリー：スマホでは横スクロール、PCではサイドバー風 */
        .category-container {
            position: sticky; top: 70px; z-index: 100;
            background: rgba(11, 29, 46, 0.9);
            backdrop-filter: blur(10px);
            padding: 10px 0; margin-bottom: 20px;
            overflow-x: auto; white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }
        .cat-list { display: inline-flex; gap: 10px; list-style: none; padding: 0 5px; margin: 0; }
        .cat-item { 
            padding: 6px 15px; border-radius: 20px; border: 1px solid #1e3a5f;
            color: #94a3b8; font-size: 0.8rem; cursor: pointer; transition: 0.3s;
        }
        .cat-item.active { background: #00aeef; color: white; border-color: #00aeef; font-weight: 900; }

        /* ブログカード */
        .blog-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .blog-card { 
            background: rgba(16, 42, 67, 0.4); border-radius: 12px; border: 1px solid #1e3a5f;
            padding: 20px; cursor: pointer; position: relative; overflow: hidden;
        }
        .blog-card h3 { font-size: 1rem; margin: 10px 0 0; line-height: 1.5; color: #fff; }
        .category-label { background: #00aeef; font-size: 0.6rem; padding: 2px 8px; border-radius: 4px; font-family: 'Orbitron'; }
        .date-text { color: #00aeef; font-family: 'Orbitron'; font-size: 0.75rem; }

        /* ビューワー */
        #blog-viewer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0b1d2e; z-index: 20000; overflow-y: auto; }
        .viewer-inner { max-width: 800px; margin: 0 auto; padding: 80px 20px 40px; position: relative; }
        
        /* 盗撮防止ガードレイヤー */
        .viewer-inner::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(45deg, rgba(0,0,0,0) 0px, rgba(0,0,0,0) 2px, rgba(255,255,255,0.01) 3px);
            pointer-events: none; z-index: 20001;
        }

        .markdown-body img { 
            display: block; max-width: 100%; height: auto; border-radius: 8px; margin: 20px auto;
            pointer-events: none; -webkit-touch-callout: none;
        }

        .close-btn { 
            position: fixed; top: 20px; right: 20px; z-index: 21000;
            background: #ff4d4d; color: white; border: none; padding: 10px 20px; 
            border-radius: 50px; font-family: 'Orbitron'; font-weight: 900;
        }

        /* 警告表示 */
        .auth-lock { 
            background: rgba(255, 77, 77, 0.1); border: 1px solid #ff4d4d; 
            color: #ff4d4d; padding: 20px; border-radius: 10px; text-align: center;
            font-size: 0.9rem; margin-top: 50px;
        }

        /* スマホ向け調整 */
        @media (max-width: 600px) {
            .blog-grid { grid-template-columns: 1fr; }
            .viewer-inner { padding-top: 70px; }
            .main-layout { padding-top: 80px; }
        }
    </style>
</head>
<body oncontextmenu="return false;" onselectstart="return false;" onkeydown="return false_keys(event);">

    <div id="nav-container"></div>

    <div class="category-container">
        <ul class="cat-list" id="category-list">
            <li class="cat-item active" onclick="filterCategory('ALL', this)">ALL</li>
        </ul>
    </div>

    <main class="main-layout">
        <div id="blog-list" class="blog-grid">記事を読み込み中...</div>
    </main>

    <div id="blog-viewer">
        <button class="close-btn" onclick="closePost()">CLOSE</button>
        <div class="viewer-inner">
            <div id="post-content" class="markdown-body"></div>
        </div>
    </div>

    <script src="/menu.js"></script>
    <script>
        function false_keys(e) {
            if (e.ctrlKey && (e.keyCode === 67 || e.keyCode === 85 || e.keyCode === 83 || e.keyCode === 80) || e.keyCode === 123) {
                alert("セキュリティ保護のため禁止されています。盗撮厳禁。");
                return false;
            }
        }

        const REPO = "emr-snn-dev/emr-snn-dev.github.io";
        let isUserAuth = false;

        firebase.auth().onAuthStateChanged((user) => {
            isUserAuth = !!user;
            initBlog();
        });

        async function initBlog() {
            const res = await fetch(`https://api.github.com/repos/${REPO}/contents/blog`);
            const files = await res.json();
            const mdFiles = files.filter(f => f.name.endsWith('.md')).reverse();
            const cats = new Set();
            
            const posts = mdFiles.map(f => {
                const name = f.name.replace('.md', '');
                const c = name.match(/\[(.*?)\]/)?.[1] || 'TECH';
                const t = name.replace(/^\d+_/, '').replace(/\[.*?\]/, '').replace(/_/g, ' ');
                const d = name.match(/^(\d{8})/)?.[1] || '';
                cats.add(c);
                return { url: f.download_url, date: d, category: c, title: t };
            });

            const cl = document.getElementById('category-list');
            cl.innerHTML = '<li class="cat-item active" onclick="filterCategory(\'ALL\', this)">ALL</li>';
            cats.forEach(c => {
                const li = document.createElement('li');
                li.className = 'cat-item'; li.innerText = c;
                li.onclick = () => filterCategory(c, li);
                cl.appendChild(li);
            });

            document.getElementById('blog-list').innerHTML = posts.map(p => `
                <article class="blog-card" data-cat="${p.category}" onclick="openPost('${p.url}')">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="date-text">${p.date}</span>
                        <span class="category-label">${p.category}</span>
                    </div>
                    <h3>${p.title}</h3>
                </article>
            `).join('');
        }

        function filterCategory(cat, el) {
            document.querySelectorAll('.cat-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('.blog-card').forEach(card => {
                card.style.display = (cat === 'ALL' || card.dataset.cat === cat) ? 'block' : 'none';
            });
        }

        async function openPost(url) {
            const v = document.getElementById('blog-viewer');
            v.style.display = 'block';
            document.body.style.overflow = 'hidden';
            const area = document.getElementById('post-content');
            
            if (!isUserAuth) {
                area.innerHTML = '<div class="auth-lock">部員専用です。ログインしてください。盗撮・保存は厳禁です。</div>';
                return;
            }
            const res = await fetch(url);
            const md = await res.text();
            area.innerHTML = marked.parse(md);
        }

        function closePost() { 
            document.getElementById('blog-viewer').style.display = 'none'; 
            document.body.style.overflow = 'auto';
        }
    </script>
</body>
</html>
